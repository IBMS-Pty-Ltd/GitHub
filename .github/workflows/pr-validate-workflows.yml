name: Validate Reusable Workflows

on:
  pull_request:
    paths:
      - ".github/workflows/**"

permissions:
  contents: read
  pull-requests: write  # Needed for commenting on the PR
  checks: write         # Needed for annotations

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------------------------
      # YAML Lint
      # ----------------------------------------------------------------------
      - name: Install yamllint
        run: sudo apt-get install -y yamllint

      - name: Validate YAML Syntax
        run: |
          echo "Checking YAML syntax..."
          yamllint -d "{extends: relaxed, rules: {line-length: disable, truthy: disable}}" .github/workflows

      # ----------------------------------------------------------------------
      # GitHub Workflow Linter
      # ----------------------------------------------------------------------
      - name: Run actionlint
        uses: devops-actions/actionlint@e7ee33fbf5aa8c9f9ee1145137f3e52e25d6a35b #v0.1.3

      # ----------------------------------------------------------------------
      # Custom validation: metadata + input type checking
      # ----------------------------------------------------------------------
      - name: Custom workflow validation
        id: custom-validate
        run: |
          echo "Validating reusable workflow metadata and inputs…"

          ERRORS=""

          # Safe globbing using an array so filenames with spaces are handled
          WORKFLOW_FILES=( .github/workflows/*.yml .github/workflows/*.yaml )

          for wf in "${WORKFLOW_FILES[@]}"; do
            # Skip non-existing globs
            [ -e "$wf" ] || continue

            echo "Checking $wf"

            # metadata check: must have a 'name:'
            if ! grep -qE '^name:' "$wf"; then
              ERRORS+="❌ $wf is missing top-level 'name:' metadata.\n"
            fi

            # must be reusable: requires 'on.workflow_call'
            if ! grep -q "workflow_call" "$wf"; then
              ERRORS+="❌ $wf does not define 'on.workflow_call', so it's not a reusable workflow.\n"
            fi

            # inputs must define type
            INPUTS_SECTION="$(yq eval '.on.workflow_call.inputs' "$wf" 2>/dev/null)"
            if [ "$INPUTS_SECTION" != "null" ]; then
              # Read input keys safely into an array
              mapfile -t INPUT_KEYS < <(echo "$INPUTS_SECTION" | yq eval 'keys | .[]' -)

              for input in "${INPUT_KEYS[@]}"; do
                type="$(yq eval ".on.workflow_call.inputs.${input}.type" "$wf")"
                if [ "$type" == "null" ]; then
                  ERRORS+="❌ $wf: Input '$input' is missing a 'type:' field.\n"
                fi
              done
            fi
          done

          if [ -n "$ERRORS" ]; then
            echo -e "$ERRORS" > validation_errors.txt
            echo "errors-found=true" >> "$GITHUB_OUTPUT"
          else
            echo "No metadata or input type issues found."
            echo "errors-found=false" >> "$GITHUB_OUTPUT"
          fi

      # ----------------------------------------------------------------------
      # Annotate PR + comment results
      # ----------------------------------------------------------------------
      - name: Upload annotations
        if: steps.custom-validate.outputs.errors-found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: workflow-validation-errors
          path: validation_errors.txt

      - name: Comment on PR with results
        if: steps.custom-validate.outputs.errors-found == 'true'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          path: validation_errors.txt

      - name: Fail the job if errors found
        if: steps.custom-validate.outputs.errors-found == 'true'
        run: |
          echo "❌ Workflow validation failed."
          exit 1
