name: dotnet_pull-request

on:
  workflow_call:
    inputs:
      solution-path:
        description: "Path to the solution file to restore. If not provided, searches the current directory for a project or solution"
        required: false
        type: string
        default: '.'
      dotnet-version:
        description: ".NET Core Version"
        required: false
        type: string
        default: '8.0.x'
      dependency-config-path:
        description: "Path to the Directory.Packages.props"
        required: false
        type: string
        default: './Directory.Packages.props'
    secrets:
      FEED_ACCESSTOKEN:
        required: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      VSS_NUGET_EXTERNAL_FEED_ENDPOINTS: '{"endpointCredentials": [{"endpoint":"https://pkgs.dev.azure.com/AvaniSolutions/_packaging/IBMS/nuget/v3/index.json","password":"${{ secrets.FEED_ACCESSTOKEN }}"}]}'
    steps:
      - name: Checkout caller repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          path: caller   # <â€” key fix

      - name: Prepare NuGet Credential Provider
        uses: ./.github/actions/nuget-authenticate/prepare-cred-provider

      - name: Setup .NET
        uses: ./.github/actions/prepare-dotnet
        with:
          dependency-config-path: ${{ inputs.dependency-config-path }}
          dotnet-version: ${{ inputs.dotnet-version }}
          solution-path: ${{ inputs.solution-path }}

      - name: Build Solution
        run: dotnet build caller/${{ inputs.solution-path }} --no-restore --configuration Release

      - name: Run Tests
        run: dotnet test caller/${{ inputs.solution-path }} --no-build
