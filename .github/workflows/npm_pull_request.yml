name: dotnet_pull_request

on:
  workflow_call:
    inputs:
      node-version:
        required: false
        type: string
        default: '20.x'
    secrets:
      NPM_TOKEN:
        required: true
      NEXT_PUBLIC_MUI_KEY:
        required: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Configure npm authentication for Azure DevOps feed
        run: |
          # Azure DevOps Artifacts feed authentication
          # Verify the token exists
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "ERROR: NPM_TOKEN secret is not set or is empty!"
            exit 1
          fi

          echo "NPM_TOKEN is set (length: ${#NPM_TOKEN})"

          # Base64 encode just the PAT token
          AUTH_TOKEN=$(echo -n "$NPM_TOKEN" | base64 -w 0)

          # Write authentication to .npmrc using the exact format Azure DevOps expects
          cat >> .npmrc <<EOF
          //pkgs.dev.azure.com/AvaniSolutions/_packaging/avani-ui/npm/registry/:username=AvaniSolutions
          //pkgs.dev.azure.com/AvaniSolutions/_packaging/avani-ui/npm/registry/:_password=${AUTH_TOKEN}
          //pkgs.dev.azure.com/AvaniSolutions/_packaging/avani-ui/npm/registry/:email=npm requires email to be set but doesn't use the value
          //pkgs.dev.azure.com/AvaniSolutions/_packaging/avani-ui/npm/:username=AvaniSolutions
          //pkgs.dev.azure.com/AvaniSolutions/_packaging/avani-ui/npm/:_password=${AUTH_TOKEN}
          //pkgs.dev.azure.com/AvaniSolutions/_packaging/avani-ui/npm/:email=npm requires email to be set but doesn't use the value
          EOF

          echo "âœ“ Authentication configured for Azure DevOps feed"
          echo "âœ“ Added credentials for registry and npm paths"
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Install dependencies
        run: npm ci
        env:
          NEXT_PUBLIC_MUI_KEY: ${{ secrets.NEXT_PUBLIC_MUI_KEY }}

      - name: Lint
        run: npm run lint

      - name: Run Tests
        run: npm run test-ci # run tests (configured to use jest-junit reporter)

      - name: Report test results
        if: ${{ !cancelled() }}
        uses: dorny/test-reporter@v2
        with:
          name: test-results
          path: reports/jest-*.xml
          reporter: jest-junit
          fail-on-error: true
          fail-on-empty: false
