name: release
# Build a single docker image and push infrastructure artiface to octopus
# NOTE: if doing multiple docket images, then will need to use individual "_" workflow templates in actual repo

on:
  workflow_call:
    inputs:
      git-version-path:
        description: "Path to GitVersionConfig.yml"
        required: false
        type: string
        default: './GitVersionConfig.yml'
      image-name:
        description: "Name of the docker image"
        required: true
        type: string
      dockerfile-path:
        description: "Path to Dockerfile that building"
        required: true
        type: string
      infrastructure-prefix:
        description: "Prefix of the octopus infrastructure package"
        required: true
        type: string
      bicep-paths:
        description: "Comma separated list of bicep build path(s)"
        required: true
        type: string
      bicep-folder:
        description: "Folder to bicep infrastructure files (eg /infra/bicep)"
        required: true
        type: string
      requires-bicep-submodule:
        description: "If need to checkout the Avani.Core.Infra.Bicep submodule (obsolete, should migrate to using avm)"
        required: false
        type: boolean
        default: false
    secrets:
      ACR_USERNAME:
        required: true
      ACR_PASSWORD:
        required: true
      OCTOPUS_URL:
        required: true
      OCTOPUS_API_KEY:
        required: true
      FEED_ACCESSTOKEN:
        required: false
      NEXT_PUBLIC_MUI_KEY:
        required: false

jobs:
  version-info:
    uses: ./.github/workflows/_version-info.yml
    with:
      git-version-path: ${{ inputs.git-version-path }}

  build-docker:
    needs: version-info
    uses: ./.github/workflows/_docker-image.yml
    with:
      image-name: ${{ inputs.image-name }}
      dockerfile-path: ${{ inputs.dockerfile-path }}
      version-number: ${{ needs.version-info.outputs.version-number }}
    secrets: inherit

  package-infrastructure:
    needs:
      - version-info
      - build-docker
    uses: ./.github/workflows/_octopus-artifact.yml
    with:
      infrastructure-prefix: ${{ inputs.infrastructure-prefix }}
      version-number: ${{ needs.version-info.outputs.version-number }}
      bicep-paths: ${{ inputs.bicep-paths }}
      bicep-folder: ${{ inputs.bicep-folder }}
      requires-bicep-submodule: ${{ inputs.requires-bicep-submodule }}
    secrets: inherit
